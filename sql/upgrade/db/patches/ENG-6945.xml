<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="ENG-6945-01" author="mdaly">
        <comment>Load residual risks for Natera-based HorizonDiseases based on risks from Sinai-based HorizonDiseases</comment>
        <sql>
            INSERT INTO `prodlims`.`horizon_risk_data`
            (`disease_id`, `displayOrder`, `ethnicity`, `riskafter`, `riskbefore`)
            SELECT d2.`id`, r.`displayOrder`, r.`ethnicity`, r.`riskafter`, r.`riskbefore`
            FROM `prodlims`.`horizon_risk_data` r
                JOIN `prodlims`.`horizondisease` d ON r.disease_id = d.id
                JOIN (SELECT `id`, `mutation` FROM `prodlims`.`horizondisease` WHERE `provider` = 'NATERA_LAB') as d2 ON d2.`mutation` = d.`mutation`
            WHERE d.`provider` = 'MTSINAI';
        </sql>

        <rollback>
            SET SQL_SAFE_UPDATES=0;
            DELETE r FROM `prodlims`.`horizon_risk_data` r JOIN `prodlims`.`horizondisease` d ON r.`disease_id` = d.`id` WHERE  d.`provider` = 'NATERA_LAB';
            SET SQL_SAFE_UPDATES=1;
        </rollback>
    </changeSet>
</databaseChangeLog>
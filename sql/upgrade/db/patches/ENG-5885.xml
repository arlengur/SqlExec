<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="ENG-5885-01" author="mdaly">
        <comment>Create new tables for new entities and extend existing HorizonDisease</comment>
        <sql>
            <![CDATA[
            CREATE TABLE `HorizonCloudResult` (
                `DTYPE` VARCHAR(31) NOT NULL,
                `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
                `casefile_id` BIGINT(20) NOT NULL,
                `resultClassification_id` BIGINT(20),
                `clsReviewer1` VARCHAR(255) NOT NULL,
                `clsReviewer2` VARCHAR(255) NOT NULL,
                `curatorReviewer` VARCHAR(255),
                `labDirectorReviewer` VARCHAR(255),
                `requiresReview` BOOLEAN NOT NULL,

                `variant_id` BIGINT(20),
                `alleleRatio` DECIMAL(19,2),
                `altValue` VARCHAR(200),
                `coordinates` INTEGER,
                `evidenceAndStrengthCodes` VARCHAR(255),
                `exon` INTEGER,
                `hgvsVariantname` VARCHAR(200),
                `proteinChange` VARCHAR(400),
                `referenceValue` VARCHAR(200),
                `vus_url` VARCHAR(255),
                `zygosity` VARCHAR(255),

                `cggRepeatCount1` INTEGER,
                `cggRepeatCount2` INTEGER,
                `cggRepeatCount3` INTEGER,
                `allele3minor` BOOLEAN,

                `plasmaHexAPercent` DECIMAL(19,2),
                `plasmaHexActivity` DECIMAL(19,2),
                `wbcHexAPercent` DECIMAL(19,2),
                `wbcHexActivity` DECIMAL(19,2),

                `resultOverride_id` BIGINT(20),

                PRIMARY KEY (`id`),

                KEY `FK_horizoncloudresult_casefile` (`casefile_id`),
                CONSTRAINT `FK_horizoncloudresult_casefile_id` FOREIGN KEY (`casefile_id`) REFERENCES `CaseFile` (`id`),

                KEY `FK_horizoncloudresult_horizonclassification` (`resultClassification_id`),
                CONSTRAINT `FK_horizoncloudresult_horizonclassification_id` FOREIGN KEY (`resultClassification_id`) REFERENCES `horizonclassification` (`id`),

                KEY `FK_horizoncloudresult_horizonvariant` (`variant_id`),
                CONSTRAINT `FK_horizoncloudresult_horizonvariant_id` FOREIGN KEY (`variant_id`) REFERENCES `horizonvariant` (`id`)
            ) ENGINE=InnoDB DEFAULT CHARSET=latin1;

            CREATE TABLE `HorizonCloudResultOverride` (
                `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
                `overriddenBy` VARCHAR(255),
                `overrideDate` DATETIME,
                `existingResult_id` BIGINT(20) NOT NULL,
                `newResult_id` BIGINT(20) NOT NULL,

                PRIMARY KEY (`id`),

                KEY `FK_horizoncloudresultoverride_existingresult` (`existingResult_id`),
                CONSTRAINT `FK_horizoncloudresultoverride_existing_horizoncloudresult_id` FOREIGN KEY (`existingResult_id`) REFERENCES `HorizonCloudResult` (`id`),

                KEY `FK_horizoncloudresultoverride_newresult` (`newResult_id`),
                CONSTRAINT `FK_horizoncloudresultoverride_new_horizoncloudresult_id` FOREIGN KEY (`newResult_id`) REFERENCES `HorizonCloudResult` (`id`)
            ) ENGINE=InnoDB DEFAULT CHARSET=latin1;

            CREATE TABLE `ReviewerNote` (
                `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
                `author` VARCHAR(255),
                `authorsRole` VARCHAR(255),
                `body` LONGTEXT CHARACTER SET utf8mb4,
                `created` DATETIME,
                PRIMARY KEY (`id`)
            ) ENGINE=InnoDB DEFAULT CHARSET=latin1;

            CREATE TABLE `HorizonCloudResult_ReviewerNote` (
                `horizonCloudResult_id` BIGINT(20) NOT NULL,
                `reviewerNotes_id` BIGINT(20) NOT NULL,

                CONSTRAINT `UK_horizoncloudresult_reviewernote_reviewernotes_id` UNIQUE (`reviewerNotes_id`),

                KEY `FK_ horizoncloudresult_reviewernote_reviewernotes` (`reviewerNotes_id`),
                CONSTRAINT `FK_horizoncloudresult_reviewernote_reviewernote_id` FOREIGN KEY (`reviewerNotes_id`) REFERENCES `ReviewerNote` (`id`),

                KEY `FK_horizoncloudresult_reviewernote_horizoncloudresult` (`HorizonCloudResult_id`),
                CONSTRAINT `FK_horizoncloudresult_reviewernote_horizoncloudresult_id` FOREIGN KEY (`horizonCloudResult_id`) REFERENCES `HorizonCloudResult` (`id`)
            ) ENGINE=InnoDB;

            CREATE TABLE `HorizonLdtDiseaseResult` (
                `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
                `clinicalDetails` LONGTEXT,
                `headline` LONGTEXT,
                `showDetails` BOOLEAN NOT NULL,
                `supplementPath` VARCHAR(1000),
                `disease_id` BIGINT,
                PRIMARY KEY (`id`),

                KEY `FK_horizonldtdiseaseresult_horizondisease` (`disease_id`),
                CONSTRAINT `FK_horizonldtdiseaseresult_horizondisease_id` FOREIGN KEY (`disease_id`) REFERENCES `horizondisease` (`id`)

            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

            CREATE TABLE `HorizonLdtDiseaseResult_HorizonCloudResult` (
                `horizonLdtDiseaseResult_id` BIGINT(20) NOT NULL,
                `results_id` BIGINT(20) NOT NULL,

                KEY `FK_horizonldtdiseaseresult_horizoncloudresult_cloudresult` (`results_id`),
                CONSTRAINT `FK_horizonldtdiseaseresult_horizoncloudresult_cloudresult_id` FOREIGN KEY (`results_id`) REFERENCES `HorizonCloudResult` (`id`),

                KEY `FK_horizonldtdiseaseresult_horizoncloudresult_diseaseresult` (`horizonLdtDiseaseResult_id`),
                CONSTRAINT `FK_horizonldtdiseaseresult_horizoncloudresult_diseaseresult_id` FOREIGN KEY (`horizonLdtDiseaseResult_id`) REFERENCES `HorizonLdtDiseaseResult` (`id`)
            ) ENGINE=InnoDB DEFAULT CHARSET=latin1;

            ALTER TABLE `HorizonCloudResult` ADD KEY `FK_horizoncloudresult_horizoncloudresultoverride` (`resultOverride_id`),
                ADD CONSTRAINT `FK_horizoncloudresult_horizoncloudresultoverride_id` FOREIGN KEY (`resultOverride_id`) REFERENCES `HorizonCloudResultOverride` (`id`);

            ]]>
        </sql>
        <rollback>
            SET SQL_SAFE_UPDATES = 0;

            drop table if exists `prodlims`.`HorizonLdtDiseaseResult_HorizonCloudResult`;
            drop table if exists `prodlims`.`HorizonLdtDiseaseResult`;
            drop table if exists `prodlims`.`HorizonCloudResult_ReviewerNote`;
            drop table if exists `prodlims`.`ReviewerNote`;
            drop table if exists `prodlims`.`HorizonCloudResultOverride`;
            drop table if exists `prodlims`.`HorizonCloudResult`;

            SET SQL_SAFE_UPDATES = 1;
        </rollback>
    </changeSet>
</databaseChangeLog>


